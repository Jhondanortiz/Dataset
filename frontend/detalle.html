<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detalle Vulnerabilidad - VulneraDB 2025</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
  <style>
    :root { --primary:#c31432; --bg:#0f0f1a; --card:#1a1a2e; --text:#e0e0e0; --border:#33334d; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--bg); color:var(--text); font-family:'Segoe UI',system-ui,sans-serif; }
    header { background:linear-gradient(135deg,#1a0033,var(--primary)); padding:40px 20px; text-align:center; }
    h1 { font-size:3rem; }
    .container { max-width:1100px; margin:40px auto; padding:0 20px; }
    .breadcrumbs { margin-bottom:30px; font-size:1.1rem; }
    .breadcrumbs a { color:#ff6b6b; text-decoration:none; }
    .breadcrumbs a:hover { text-decoration:underline; }
    .detail-card { background:var(--card); padding:40px; border-radius:20px; border:1px solid var(--border); }
    .cve { font-size:3rem; color:var(--primary); font-family:'Courier New',monospace; margin:20px 0; }
    .cvss { padding:12px 30px; border-radius:50px; font-size:1.5rem; font-weight:bold; }
    .critical { background:#e74c3c; } .high { background:#e67e22; } .medium { background:#f39c12; color:#000; } .low { background:#27ae60; }
    .section { margin:35px 0; }
    .section h3 { margin-bottom:15px; border-bottom:2px solid var(--primary); padding-bottom:8px; font-size:1.6rem; color:#ff6b6b; }
    .tag { display:inline-block; padding:10px 20px; border-radius:50px; background:rgba(195,20,50,0.2); color:#ff6b6b; margin:8px 8px 8px 0; }
    .btn-back { display:inline-block; margin-top:40px; padding:16px 40px; background:var(--primary); color:white; text-decoration:none; border-radius:12px; }
    .btn-back:hover { background:#a1122a; }
    .loading { text-align:center; padding:60px; }
  </style>
</head>
<body>

<header>
  <h1><a href="index.html" style="color:white;text-decoration:none;">VulneraDB</a> → Detalle</h1>
</header>

<div class="container">
  <div class="breadcrumbs">
    <a href="index.html">Inicio</a> →
    <a id="linkGrupo" href="#">Grupo</a> →
    <a id="linkSubgrupo" href="#">Subgrupo</a> →
    <span id="vulnName">Cargando...</span>
  </div>

  <div class="detail-card" id="detailCard">
    <div class="loading">
      <i class="fas fa-spinner fa-spin" style="font-size:3rem;"></i>
      <p>Cargando vulnerabilidad...</p>
    </div>
  </div>
</div>

<script>
  const API = "http://127.0.0.1:8000";
  const id = new URLSearchParams(window.location.search).get("id");

  async function cargarDetalle() {
    const card = document.getElementById("detailCard");

    if (!id) {
      card.innerHTML = `<div class="error-message"><h2>ID inválido</h2></div>`;
      return;
    }

    try {
      // === 1. Obtener vulnerabilidad ===
      const res = await fetch(`${API}/api/vulnerabilities/${id}`);
      if (!res.ok) throw new Error("Vulnerabilidad no encontrada.");
      const v = await res.json();

      // === 2. Cargar grupos ===
      const gRes = await fetch(`${API}/api/groups`);
      const grupos = (await gRes.json()).groups;
      const grupo = grupos.find(g => g.id === v.group_id) || { id: 0, name: "Grupo desconocido" };

      // === 3. Cargar subgrupos ===
      const sRes = await fetch(`${API}/api/subgroups`);
      const subgrupos = (await sRes.json()).subgroups;
      const subgrupo = subgrupos.find(s => s.id === v.subgroup_id) || { id: 0, name: "Subgrupo desconocido" };

      // === 4. Renderizado ===
      renderDetalle(v, grupo, subgrupo);

    } catch (err) {
      card.innerHTML = `
        <div class="error-message">
          <h2>Error al cargar</h2>
          <p>${err.message}</p>
          <a href="index.html" class="btn-back">Volver</a>
        </div>`;
    }
  }

  function renderDetalle(v, grupo, subgrupo) {
    const cvssNum = parseFloat(v.cvss_v4 || 0);
    let cvssClass = "low";
    if (cvssNum >= 9) cvssClass = "critical";
    else if (cvssNum >= 7) cvssClass = "high";
    else if (cvssNum >= 4) cvssClass = "medium";

    document.getElementById("vulnName").textContent = v.cve || "Sin CVE";
    document.getElementById("linkGrupo").textContent = grupo.name;
    document.getElementById("linkGrupo").href = `grupo.html?id=${grupo.id}`;
    document.getElementById("linkSubgrupo").textContent = subgrupo.name;
    document.getElementById("linkSubgrupo").href = `subgrupo.html?id=${subgrupo.id}`;

    document.getElementById("detailCard").innerHTML = `
      <div class="cve">${v.cve || "Sin CVE"}</div>
      <h2>${v.vulnerability_name}</h2>
      <div class="cvss ${cvssClass}">${v.cvss_v4 ?? "N/D"}</div>

      <div class="section">
        <h3>Descripción</h3>
        <p>${v.description}</p>
      </div>

      <div class="section">
        <h3>Información Técnica</h3>
        <p><strong>CWE:</strong> ${v.cwe_name}</p>
        <p><strong>Vector CVSS:</strong> <code>${v.cvss_vector}</code></p>
        <p><strong>Publicado:</strong> ${v.published_date?.split("T")[0] || "N/A"}</p>
      </div>

      <div class="section">
        <h3>Categorización</h3>
        <span class="tag">${grupo.name}</span>
        <span class="tag">Subgrupo: ${subgrupo.name}</span>
      </div>

      <a href="index.html" class="btn-back">Volver</a>
    `;
  }

  window.onload = cargarDetalle;
</script>

</body>
</html>
