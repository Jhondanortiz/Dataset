<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VulneraDB 2025 - 128 Vulnerabilidades Críticas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
  <style>
    :root {
      --primary: #c31432;
      --primary-dark: #a1122a;
      --bg: #0f0f1a;
      --card: #1a1a2e;
      --text: #e0e0e0;
      --text-light: #aaaaaa;
      --border: #33334d;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, sans-serif;
      line-height: 1.6;
      min-height: 100vh;
    }
    header {
      background: linear-gradient(135deg, #1a0033, #c31432);
      text-align: center;
      padding: 60px 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    }
    h1 { font-size: 4.5rem; margin-bottom: 10px; }
    h1 span { color: #ff3366; }
    .subtitle { font-size: 1.6rem; opacity: 0.9; }

    .container { max-width: 1400px; margin: 40px auto; padding: 0 20px; }

    .filters {
      background: var(--card);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.4);
      margin-bottom: 40px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    select, input {
      padding: 16px 20px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: #16213e;
      color: white;
      font-size: 1.1rem;
    }
    select:focus, input:focus { outline: none; border-color: var(--primary); }

    .btn {
      padding: 16px 32px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      transition: all 0.3s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-4px); }
    .btn-secondary { background: #333; color: white; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 30px;
    }
    .card {
      background: var(--card);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0,0,0,0.5);
      transition: all 0.4s ease;
      border: 1px solid var(--border);
    }
    .card:hover {
      transform: translateY(-15px);
      box-shadow: 0 30px 60px rgba(195,20,50,0.4);
    }
    .card-header {
      padding: 25px;
      background: linear-gradient(135deg, rgba(195,20,50,0.2), transparent);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-title { font-size: 1.6rem; font-weight: bold; }
    .cvss {
      padding: 12px 24px;
      border-radius: 50px;
      font-weight: bold;
      font-size: 1.3rem;
    }
    .critical { background: #e74c3c; }
    .high { background: #e67e22; }
    .medium { background: #f39c12; color: black; }
    .low { background: #27ae60; }

    .card-body { padding: 28px; }
    .cve {
      font-size: 2.2rem;
      font-weight: bold;
      color: var(--primary);
      margin: 15px 0;
      font-family: 'Courier New', monospace;
    }
    .description {
      margin: 20px 0;
      color: var(--text-light);
      line-height: 1.8;
    }
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 20px;
    }
    .tag {
      background: rgba(195,20,50,0.2);
      color: #ff6b6b;
      padding: 10px 18px;
      border-radius: 50px;
      font-size: 0.95rem;
      font-weight: 500;
      border: 1px solid rgba(195,20,50,0.3);
    }

    .stats {
      text-align: center;
      margin: 50px 0;
      font-size: 2rem;
      color: var(--primary);
    }
    .status {
      padding: 15px;
      border-radius: 12px;
      margin: 20px 0;
      text-align: center;
      font-weight: bold;
    }
    .success { background: rgba(40,167,69,0.2); color: #28a745; border: 1px solid #28a745; }
    .error { background: rgba(220,53,69,0.2); color: #dc3545; border: 1px solid #dc3545; }
  </style>
</head>
<body>

  <header>
    <h1>Vulnera<span>DB</span> 2025</h1>
    <p class="subtitle">128 Vulnerabilidades de Alto Impacto • Filtros por Grupo y Subgrupo</p>
  </header>

  <div class="container">

    <div class="filters">
      <input type="text" id="searchInput" placeholder="Buscar por CVE, título, descripción...">

      <select id="groupFilter">
        <option value="">Todos los grupos</option>
      </select>

      <select id="subgroupFilter">
        <option value="">Todos los subgrupos</option>
      </select>

      <input type="number" step="0.1" min="0" max="10" id="minCvss" placeholder="CVSS mínimo">
      <input type="number" step="0.1" min="0" max="10" id="maxCvss" placeholder="CVSS máximo">

      <div style="display:flex; gap:15px;">
        <button class="btn btn-primary" onclick="buscar()">BUSCAR</button>
        <button class="btn btn-secondary" onclick="limpiarFiltros()">LIMPIAR</button>
      </div>
    </div>

    <div id="status" class="status success" style="display:none;"></div>

    <div id="resultados" class="grid"></div>

    <div class="stats">
      <span id="totalCount">0</span> vulnerabilidades encontradas
    </div>
  </div>

  <script>
    const API = "http://127.0.0.1:8000";
    let allGroups = [];
    let allSubgroups = [];

    // Cargar grupos al iniciar
    async function cargarGrupos() {
      try {
        const res = await fetch(`${API}/api/groups`);
        const data = await res.json();
        allGroups = data.groups;
        const select = document.getElementById("groupFilter");
        allGroups.forEach(g => {
          const opt = document.createElement("option");
          opt.value = g.id;
          opt.textContent = g.name;
          select.appendChild(opt);
        });
      } catch (e) { console.error("Error cargando grupos"); }
    }

    // Cargar subgrupos cuando cambie el grupo
    document.getElementById("groupFilter").addEventListener("change", async function() {
      const groupId = this.value;
      const subSelect = document.getElementById("subgroupFilter");
      subSelect.innerHTML = '<option value="">Todos los subgrupos</option>';
      subSelect.disabled = !groupId;

      if (!groupId) return;

      try {
        const res = await fetch(`${API}/api/subgroups/${groupId}`);
        const data = await res.json();
        data.subgroups.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = s.name;
          subSelect.appendChild(opt);
        });
      } catch (e) { console.error("Error cargando subgrupos"); }
    });

    async function buscar() {
      const q = document.getElementById("searchInput").value.trim();
      const groupId = document.getElementById("groupFilter").value;
      const subgroupId = document.getElementById("subgroupFilter").value;
      const minCvss = document.getElementById("minCvss").value;
      const maxCvss = document.getElementById("maxCvss").value;

      let url = `${API}/api/vulnerabilities?limit=200`;
      if (q) url += `&q=${encodeURIComponent(q)}`;
      if (groupId) url += `&group_id=${groupId}`;
      if (subgroupId) url += `&subgroup_id=${subgroupId}`;
      if (minCvss) url += `&min_cvss=${minCvss}`;
      if (maxCvss) url += `&max_cvss=${maxCvss}`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("API no responde");
        const data = await res.json();
        const vulns = data.vulnerabilities || data;

        mostrarVulnerabilidades(vulns);
        document.getElementById("status").style.display = "block";
        document.getElementById("status").textContent = "Conexión exitosa • " + vulns.length + " resultados";
        document.getElementById("status").className = "status success";

      } catch (err) {
        document.getElementById("status").style.display = "block";
        document.getElementById("status").textContent = "ERROR: API no iniciada → Ejecuta: uvicorn api.main:app --reload";
        document.getElementById("status").className = "status error";
      }
    }

    function mostrarVulnerabilidades(vulns) {
      const cont = document.getElementById("resultados");
      document.getElementById("totalCount").textContent = vulns.length;

      if (vulns.length === 0) {
        cont.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:100px; font-size:2.5rem; color:#555;">
                          No se encontraron vulnerabilidades
                         </div>`;
        return;
      }

      cont.innerHTML = "";
      vulns.forEach(v => {
        const cvss = v.cvss_v4 ? parseFloat(v.cvss_v4).toFixed(1) : "N/D";
        let clase = "low";
        if (v.cvss_v4 >= 9.0) clase = "critical";
        else if (v.cvss_v4 >= 7.0) clase = "high";
        else if (v.cvss_v4 >= 4.0) clase = "medium";

        const grupo = allGroups.find(g => g.id === v.group_id)?.name || "Otro";
        const subgrupo = allSubgroups.find(s => s.id === v.subgroup_id)?.name || "Otro";

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-header">
            <div class="card-title">${v.vulnerability_name || "Sin nombre"}</div>
            <div class="cvss ${clase}">${cvss}</div>
          </div>
          <div class="card-body">
            <div class="cve">${v.cve || "— Sin CVE —"}</div>
            <div class="description">${(v.description || "").substring(0, 180)}...</div>
            <div class="tags">
              <span class="tag"><i class="fas fa-shield-alt"></i> ${grupo}</span>
              <span class="tag"><i class="fas fa-layer-group"></i> ${subgrupo}</span>
              <span class="tag"><i class="fas fa-bug"></i> ${v.cwe_name || "CWE desconocido"}</span>
            </div>
          </div>
        `;
        card.onclick = () => {
          const id = v.id || v._id;
          if (id) {
            window.location.href = `detalle.html?id=${id}`;
          } else {
            console.error("Vulnerabilidad sin ID:", v);
          }
        };
        cont.appendChild(card);
      });
    }

    function limpiarFiltros() {
      document.getElementById("searchInput").value = "";
      document.getElementById("groupFilter").value = "";
      document.getElementById("subgroupFilter").value = "";
      document.getElementById("subgroupFilter").disabled = true;
      document.getElementById("minCvss").value = "";
      document.getElementById("maxCvss").value = "";
      buscar();
    }

    // Cargar todo al iniciar
    window.onload = () => {
      cargarGrupos();
      buscar();
    };
  </script>
</body>
</html>